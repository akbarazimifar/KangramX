kind: pipeline
name: KangX Build

steps:
- name: Install runtime dependencies
  image: ubuntu:latest
  commands:
  - apt update
  - apt install -y golang ninja-build python3-pip openjdk-11-jdk-headless wget unzip build-essential git

- name: Checkout build submodules
  image: ubuntu:latest
  commands:
  - git submodule update --init --recursive --depth 1

- name: Download and extract Android tools
  image: ubuntu:latest
  commands:
  - mkdir ~/Android
  - cd ~/Android
  - wget https://dl.google.com/android/repository/commandlinetools-linux-6609375_latest.zip -O commandlinetools.zip
  - unzip commandlinetools.zip

- name: Install Android NDK and accept licenses
  image: ubuntu:latest
  commands:
  - export ANDROID_HOME=~/Android
  - export PATH=$ANDROID_HOME/tools/bin:$PATH
  - sdkmanager 'ndk;21.3.6528147'
  - yes | sdkmanager --licenses

- name: Patch and build ffmpeg
  image: ubuntu:latest
  commands:
  - export NDK=$ANDROID_HOME/ndk/21.3.6528147
  - cd TMessagesProj/jni
  - ./build_ffmpeg_clang.sh
  - ./patch_ffmpeg.sh

- name: Patch and build boringssl
  image: ubuntu:latest
  commands:
  - export NDK=$ANDROID_HOME/ndk/21.3.6528147
  - cd TMessagesProj/jni
  - ./patch_boringssl.sh
  - ./build_boringssl.sh

- name: Build
  image: ubuntu:latest
  commands:
  - USE_SPLITBUILD=1 ./gradlew assembleRelease
  environment:
    APP_ID:
      from_secret: APP_ID
    APP_HASH:
      from_secret: APP_HASH
    ALIAS_NAME:
      from_secret: ALIAS_NAME
    ALIAS_PASS:
      from_secret: ALIAS_PASS
    KEYSTORE_PASS:
      from_secret: KEYSTORE_PASS
